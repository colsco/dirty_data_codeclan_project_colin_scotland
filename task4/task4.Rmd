---
title: "Halloween Sweets Analysis"
author: "Colin Scotland"
date: "29/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Set up libraries;
```{r}
library(tidyverse)
library(here)
library(assertr)
```

Set 'home' directory;
```{r}
here::here()
```

Source cleaning script;

```{r}
source("data_cleaning_scripts/halloween_candy_cleaning_script.R")
```

## 1. What is the total number of candy ratings given across three years.
## (Number of candy ratings, not the number of raters.  Don't count missing values).

```{r}
# Add an ID column to keep track after pivoting;
candy_all <- candy_all %>% 
  mutate(id = 1:nrow(candy_all), .before = "year")


candy_long <- candy_all %>% 
  pivot_longer(cols = c(-id, -year, -age, -gender, -country, -going_out))







candy_long_ratings <- candy_long %>% 
  
  mutate(num_ratings = if_else(value == "(?i)JOY" |
                               value == "(?i)MEH" |
                               value == "(?i)DESPAIR", as.integer(1), as.integer(0)), .after = "value") %>% 
  
  summarise(total_ratings = sum(!is.na(num_ratings)))

candy_long_ratings
  
```

#### There are **612266** ratings of sweets across the three years.  

These can also be broken down further to show how many of each type there were;

```{r}
candy_long %>% 
  
  select(value) %>% 
  
  distinct(value)
  
```

So there are only "JOY", "DESPAIR", "MEH" and NAs to deal with.

```{r}
candy_long_q1 <- candy_long %>% 
  
 # select(name, value) %>% 
  
  mutate(joy = (if_else(value == "JOY", 1, 0)), 
         despair = (if_else(value == "DESPAIR", 1, 0)), 
         meh = (if_else(value == "MEH", 1, 0)), 
         .after = "value") 

candy_long_q1 %>% 
  
  summarise(sum(joy, na.rm = TRUE), sum(despair, na.rm = TRUE), sum(meh, na.rm = TRUE))


```

Double check the count: 275261 + 260569 + 76436 = **612266**, which matches the original answer.


## 2.  What was the average age of people who are going out trick or treating?

As a start it would be good to have the age column formatted as numeric;
```{r}
candy_all <- candy_all %>% 
  
  mutate(age = round(as.integer(age), digits = 1)) 
  

```
Note: the "junk" age entries have been coerced into NAs during the `as.integer` change, leaving
only numbers and NAs.  This is *a good thing* in this case.

In theory, a parent could take a baby trick or treating, and have answered the survey 
from their baby's perspective, so ages > 0 should be accepted.  At the other end of the 
spectrum, the oldest person in the world is 119 years old, so anyone over 120 is lying. 

```{r}
candy_all <- candy_all %>% 
  filter(age > 0 & age < 120)

# and check there are no surprises;


candy_all %>% 
  filter(!is.na(age)) %>% 
  verify(age > 0 & age < 120) 
```

Now, discounting NAs we want to know what the average age is of people going out.

```{r}
candy_all %>% 
  
# what are the responses - are they only 'yes'/'no', or are there some oddities or colloquialisms in there?
  
  distinct(going_out)

# There are only 'Yes' and 'No'.

candy_all %>% 
  
  filter(going_out == "Yes") %>% 
  summarise(avg_age_out = mean(age, na.rm = TRUE))
```

#### So the average age of people going out trick or treating is just over **35 years and 1 month**.

## 3. What was the average age of people **not** going trick or treating?

Similarly to the last question;

```{r}
candy_all %>% 
  
  filter(going_out == "No") %>% 
  
  summarise(avg_age_out = mean(age, na.rm = TRUE))
```

#### The average age of people going out trick or treating is just under **39 years and 2 months**.

## 4. For each joy, despair and meh, which candy bar received the most of these ratings?

###### Note: 'gender' was left out of this, because the `na.rm = TRUE` removed the results from 2015
because there was no 'gender' result for this year.  This had a significant effect on the result and
gender was never an integral part of *this* question.  It means for question 6 I have to remake an
alternative 'candy_rating_rates' list which *does* include gender, which means that the overall
'candy_rating_rates' are not identical. 

*To be honest I think there's probably a more elegant way to present the results to this question *
*rather than having three separate tables arranged in descending order - if I get time I'll come back *
*to it. `slice_max(all_the_whatever, n = 1)` wasn't working for me for some reason.*

```{r}

candy_rating_rates <- candy_long_q1 %>% 
  
  group_by(name, joy, meh, despair) %>% 
  
  summarise(all_the_joy = sum(as.integer(joy, na.rm = TRUE)), 
            all_the_meh = sum(as.integer(meh, na.rm = TRUE)), 
            all_the_despair = sum(as.integer(despair, na.rm = TRUE))
            )

candy_rating_rates %>% 
  
  select(name, all_the_joy) %>% 
  
  arrange(desc(all_the_joy))
  
candy_rating_rates %>% 
  
  select(name, all_the_meh) %>% 
  
  arrange(desc(all_the_meh))

candy_rating_rates %>% 
  
  select(name, all_the_despair) %>% 
  
  arrange(desc(all_the_despair))
 
  
```

#### The candy bar with the most ratings of each kind were;

**JOY**       | Any full sized candy bar    | 7589 votes

**MEH**       | Lollipops                   | 1570 votes

**DESPAIR**   | Gum from baseball cards     | 7341 votes


## 5. How many people rated Starburst as despair?

```{r}
candy_rating_rates %>% 
  
select(name, all_the_despair) %>% 
  
filter(name == "starburst" & all_the_despair > 0)
```

#### There were **1990 votes of 'despair'** for Starburst.

## 6. What was the most popular candy bar by this rating system for each gender in the data set?

First, what entries do we have for gender;

```{r}
candy_long %>% 
  
  distinct(gender)
  
```
So we have to deal with 'NA', Male', 'Female', 'Other', and 'I'd rather not say'.

At least the formatting is consistent :)

```{r}
male_favourite <- candy_long_q1 %>% 
  
  select(gender, name, joy) %>% 
  
  filter(gender == "Male" & joy == 1)  %>% 
  
  group_by(name) %>% 
  
  summarise(total_joy_male = sum(joy))  

female_favourite <- candy_long_q1 %>% 
    
  filter(gender == "Female" & joy == 1) %>% 
  
  group_by(name) %>% 
  
  summarise(total_joy_female = sum(joy))  
  
other_favourite <- candy_long_q1 %>%

  filter(gender == "Other" & joy == 1) %>% 
  
  group_by(name) %>% 
  
  summarise(total_joy_other = sum(joy))  
  
nosay_favourite <- candy_long_q1 %>% 
  
  filter(gender == "I'd rather not say" & joy == 1) %>% 
  
  group_by(name) %>% 
  
  summarise(total_joy_nosay = sum(joy)) 
  
na_favourite <- candy_long_q1 %>% 
  
  filter(is.na(gender) & joy == 1) %>% 

  group_by(name) %>% 
  
  summarise(total_joy_na = (sum(joy)))
```

```{r}

slice_max(male_favourite, order_by = "total_joy_male", n = 1)

slice_max(female_favourite, order_by = "total_joy_female", n = 1)

slice_max(other_favourite, order_by = "total_joy_other", n = 1)

slice_max(nosay_favourite, order_by = "total_joy_nosay", n = 1)

slice_max(na_favourite, order_by = "total_joy_na", n = 1)



```

#### So the most popular sweets by gender are;

**Male:**                  any_full_sized_candy_bar	            1605 votes

**Female:   **             any_full_sized_candy_bar	            882	votes

**Other: **                any_full_sized_candy_bar	            38 votes

**Prefer not to say:**     any_full_sized_candy_bar	            71 votes

**NA: **                   any_full_sized_candy_bar	            4993 votes	    


The previous total count for 'any_full_sized_candy_bar' min question 4 was 7589.

In this case, 1605 + 882 + 38 + 71 + 4993 = **7589**, so the results are
consistent.

Now that there are some results I've just realised that I haven't used the system 
defined by the task of setting despair = -1, meh = 0 and joy = +1.  So redo the question;

```{r}
candy_long_q6 <- candy_long %>% 
  
  # set up the scores for ratings;
  
  mutate(value_numeric = case_when(value == "JOY" ~ as.numeric(1),
                                   value == "MEH" ~ as.numeric(0),
                                   value == "DESPAIR" ~ as.numeric(-1)))

```

The most popular sweets will be the ones with the highest scores after adding up all
the joy (+1) and despair (-1).

```{r}
q6_male <- candy_long_q6 %>% 
  
  filter(gender == "Male")  %>% 
  
  group_by(name) %>% 
  
  summarise(total_joy_male = sum(value_numeric, na.rm = TRUE))  




q6_female <- candy_long_q6 %>% 
  
  filter(gender == "Female")  %>% 
  
  group_by(name) %>% 
  
  summarise(total_joy_female = sum(value_numeric, na.rm = TRUE))  




q6_other <- candy_long_q6 %>% 
  
  filter(gender == "Other")  %>% 
  
  group_by(name) %>% 
  
  summarise(total_joy_other = sum(value_numeric, na.rm = TRUE))  




q6_nosay <- candy_long_q6 %>% 
  
  filter(gender == "I'd rather not say")  %>% 
  
  group_by(name) %>% 
  
  summarise(total_joy_male = sum(value_numeric, na.rm = TRUE))  




q6_na <- candy_long_q6 %>% 
  
  filter(is.na(gender))  %>% 
  
  group_by(name) %>% 
  
  summarise(total_joy_male = sum(value_numeric, na.rm = TRUE))  
```

That's the results grouped, so now to find the top scorers;

```{r}
slice_max(male_favourite, order_by = "q6_male", n = 1)

slice_max(female_favourite, order_by = "q6_female", n = 1)

slice_max(other_favourite, order_by = "q6_other", n = 1)

slice_max(nosay_favourite, order_by = "q6_nosay", n = 1)

slice_max(na_favourite, order_by = "q6_na", n = 1)
```

#### So the most popular sweets by gender using the *proper* system are;

**Male:**                  any_full_sized_candy_bar	            1605 votes

**Female:   **             any_full_sized_candy_bar	            882	votes

**Other: **                any_full_sized_candy_bar	            38 votes

**Prefer not to say:**     any_full_sized_candy_bar	            71 votes

**NA: **                   any_full_sized_candy_bar	            4993 votes	

...which is exactly the same as the result from not using the defined "system", 
so at least they're consistent.

